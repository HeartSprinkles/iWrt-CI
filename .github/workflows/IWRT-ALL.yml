name: immortalwrt-mt798x

on:
  workflow_dispatch:

permissions: write-all

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@main

      - name: 准备编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |

          sudo apt-get -yqq purge firefox
          sudo apt-get -yqq update
          sudo apt-get -yqq full-upgrade
          sudo apt-get -yqq autoclean
          sudo apt-get -yqq clean

          sudo apt-get -yqq install dos2unix python3-netifaces libfuse-dev
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo systemctl daemon-reload
          sudo timedatectl set-timezone "Asia/Shanghai"

      - name: 克隆源码
        uses: actions/checkout@main
        with:
          repository: chasey-dev/immortalwrt-mt798x-rebase
          ref: 25.12-dev
          path: iwrt
          filter: blob:none

      - name: Check Scripts
        run: |
          find ./ -maxdepth 3 -type f -iregex ".*\(txt\|sh\)$" -exec dos2unix {} \; -exec chmod +x {} \;

      - name: 获取 iwrt 仓库短 SHA
        id: iwrt_sha
        run: |

          echo "iwrt_sha=$(cd iwrt && git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: 缓存下载编译中间文件
        uses: actions/cache@v4
        with:
          path: |

            iwrt/dl
            iwrt/staging_dir
            iwrt/build_dir

          key: ${{ runner.os }}-immortalwrt-dl-staging-${{ steps.iwrt_sha.outputs.iwrt_sha }}-${{ hashFiles('iwrt/.config', 'iwrt/feeds.conf*', 'Config/.config') }}
          restore-keys: |
            ${{ runner.os }}-immortalwrt-dl-staging-${{ steps.iwrt_sha.outputs.iwrt_sha }}-

      - name: 缓存 ccache
        uses: actions/cache@v4
        with:
          path: |
          
            ~/.ccache

          key: ${{ runner.os }}-ccache-${{ steps.iwrt_sha.outputs.iwrt_sha }}-${{ hashFiles('iwrt/.config') }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ steps.iwrt_sha.outputs.iwrt_sha }}-

      - name: 更新订阅源
        run: |

          cd ./iwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 添加UCI配置
        run: |

          mkdir -p ./iwrt/files/etc/uci-defaults
          cp -f ./Scripts/99-custom ./iwrt/files/etc/uci-defaults/99-custom

      - name: 自定义配置文件
        run: |

          cat ./Config/diffconfig >> ./iwrt/.config
          make -C iwrt defconfig -j$(nproc)

#      - name: 安装和配置自定义包
#        run: |
#
#          cd ./iwrt/package/
#          $GITHUB_WORKSPACE/Scripts/Packages.sh

      - name: 下载依赖
        run: |

          cd ./iwrt
          make download -j$(nproc)

      - name: 编译固件
        run: |

          cd ./iwrt
          make -j$(nproc) || make -j1 V=s

      - name: 打包固件
        run: |

          cd ./iwrt/ && mkdir ./upload/
          find ./bin/targets/ -iregex ".*\(bl2\.bin\|json\|sha256sums\|packages\)$" -exec rm -rf {} +
          find ./bin/targets/ -type f -exec mv -f {} ./upload/ \;

      - name: 构建发布信息
        id: meta
        run: |
          BUILD_DATE=$(date +'%Y%m%d')
          SHORT_SHA=${GITHUB_SHA::7}
          TAG_NAME="build-${BUILD_DATE}-${SHORT_SHA}"
          RELEASE_NAME="${BUILD_DATE} (${SHORT_SHA})"
          echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "release=${RELEASE_NAME}" >> $GITHUB_OUTPUT

      - name: 发布固件
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.release }}
          body: |

            **编译信息**
            - 源码: chasey-dev/immortalwrt-mt798x-rebase
            - 分支: 25.12-dev

          files: ${{ github.workspace }}/iwrt/upload/*.*
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}