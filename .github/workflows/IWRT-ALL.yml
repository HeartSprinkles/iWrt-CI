name: immortalwrt-mt798x

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出工作流仓库
        uses: actions/checkout@main

      - name: 准备编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |

          sudo apt-get -yqq purge firefox
          sudo apt-get -yqq update
          sudo apt-get -yqq full-upgrade
          sudo apt-get -yqq autoclean
          sudo apt-get -yqq clean

          sudo apt-get -yqq install dos2unix python3-netifaces libfuse-dev
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo systemctl daemon-reload
          sudo timedatectl set-timezone "Asia/Shanghai"

      - name: 克隆源码
        uses: actions/checkout@main
        with:
          repository: chasey-dev/immortalwrt-mt798x-rebase
          ref: 25.12-dev
          path: iwrt
          filter: blob:none

      - name: Check Scripts
        run: |
          find ./ -maxdepth 3 -type f -iregex ".*\(txt\|sh\)$" -exec dos2unix {} \; -exec chmod +x {} \;

      - name: 更新订阅源
        run: |

          ./iwrt/scripts/feeds update -a
          ./iwrt/scripts/feeds install -a

      - name: 自定义配置文件
        run: |

          cat ./Config/diffconfig >> ./iwrt/.config
          make -C iwrt defconfig -j$(nproc)

      - name: 缓存 dl 目录
        uses: actions/cache@v4
        with:
          path: iwrt/dl
          key: ${{ runner.os }}-dl-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-dl-

      - name: 缓存 ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('iwrt/.config', 'iwrt/toolchain/*') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: 配置 ccache
        run: |
            ccache -M 3G    # 设置最大3GB（根据项目需求调整）
            ccache -s       # 打印当前统计信息

      - name: 下载依赖
        run: |

          make -C iwrt download -j$(nproc)

      - name: 编译固件
        run: |

          make -C iwrt -j$(nproc) || make -C iwrt -j1 V=s

      - name: 构建发布信息
        id: meta
        run: |
          GIT_HASH=$(git -C iwrt rev-parse --short=7 HEAD)
          DATE_STR=$(date +'%y.%-m.%-d')
          TAG_NAME="v${DATE_STR}-${GIT_HASH}"
          RELEASE_NAME="Release $DATE_STR"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "git_hash=$GIT_HASH" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT

          MANIFEST=$(find ./iwrt/bin/targets -type f -name "*.manifest" 2>/dev/null | head -1)
          if [ -n "$MANIFEST" ]; then
            KERNEL_VERSION=$(grep -oP '^kernel - \K[\d\.]+' "$MANIFEST")
            echo "kernel_version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "kernel_version=unknown" >> $GITHUB_OUTPUT
          fi

      - name: 生成发布文件列表
        id: filelist
        run: |
          cd iwrt
          # 收集所有固件文件，排除不需要的中间文件
          find bin/targets -type f \
            ! -path "*/packages/*" \
            ! -name "*.json" \
            ! -name "bl2.bin" \
            > filelist.txt
          # 输出列表文件的绝对路径供后续步骤使用
          echo "filelist_path=$(pwd)/filelist.txt" >> $GITHUB_OUTPUT

      - name: 发布固件
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag_name }}
          name: ${{ steps.meta.outputs.release_name }}
          body: |
            **编译信息**
            - 源码: chasey-dev/immortalwrt-mt798x-rebase
            - 分支: 25.12-dev
            - 内核版本: ${{ steps.meta.outputs.kernel_version }}
          files: '@${{ steps.filelist.outputs.filelist_path }}'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}